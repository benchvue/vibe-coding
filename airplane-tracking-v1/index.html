<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyTracker - Live Flight Tracker</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.124/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.124/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,sans-serif}
        #cesiumContainer{width:100%;height:100%}

        #topBar{
            position:absolute;top:0;left:0;right:0;z-index:10;
            display:flex;align-items:center;gap:16px;padding:10px 20px;
            background:linear-gradient(180deg,rgba(10,10,30,.92),rgba(10,10,30,.7));
            backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,200,0,.15);
        }
        #topBar .logo{display:flex;align-items:center;gap:8px;font-size:18px;font-weight:700;color:#ffd000;letter-spacing:1px;text-transform:uppercase}
        #topBar .logo svg{width:28px;height:28px}
        #topBar .stats{display:flex;gap:20px;margin-left:auto;font-size:13px;color:rgba(255,255,255,.7)}
        #topBar .stats span{color:#ffd000;font-weight:600}

        #statusBar{
            position:absolute;bottom:0;left:0;right:0;z-index:10;
            display:flex;align-items:center;justify-content:space-between;padding:6px 20px;
            background:rgba(10,10,30,.85);backdrop-filter:blur(8px);
            border-top:1px solid rgba(255,200,0,.1);font-size:12px;color:rgba(255,255,255,.5);
        }
        .api-badge{display:inline-flex;align-items:center;gap:5px;padding:2px 8px;border-radius:10px;background:rgba(255,200,0,.12);color:#ffd000;font-size:11px}
        .api-badge .dot{width:6px;height:6px;border-radius:50%;background:#4caf50;animation:pulse 2s infinite}
        .status-text{margin-left:8px;font-size:11px;color:rgba(255,255,255,.4)}
        .status-ok{color:#4caf50}
        .status-warn{color:#ff9800}
        .status-err{color:#f44336}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

        #flightPopup{
            display:none;position:absolute;z-index:100;min-width:310px;max-width:360px;
            background:linear-gradient(135deg,rgba(15,15,40,.97),rgba(25,20,50,.97));
            backdrop-filter:blur(16px);border:1px solid rgba(255,200,0,.25);border-radius:12px;
            box-shadow:0 8px 32px rgba(0,0,0,.6),0 0 60px rgba(255,200,0,.05);
            pointer-events:none;overflow:hidden;
        }
        #flightPopup.visible{display:block}
        .popup-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 10px;background:rgba(255,200,0,.06);border-bottom:1px solid rgba(255,200,0,.1)}
        .popup-header .callsign{font-size:20px;font-weight:800;color:#ffd000;letter-spacing:1.5px}
        .popup-header .country{font-size:12px;color:rgba(255,255,255,.5);background:rgba(255,255,255,.06);padding:3px 10px;border-radius:20px}
        .popup-body{padding:12px 16px 16px}
        .popup-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .popup-item{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:8px;padding:8px 10px}
        .popup-item .label{font-size:10px;text-transform:uppercase;color:rgba(255,255,255,.35);letter-spacing:.8px;margin-bottom:3px}
        .popup-item .value{font-size:14px;font-weight:600;color:#fff}
        .popup-item .unit{font-size:10px;color:rgba(255,255,255,.3);margin-left:2px}

        #loadingOverlay{
            position:absolute;inset:0;z-index:200;display:flex;flex-direction:column;
            align-items:center;justify-content:center;background:rgba(5,5,20,.95);transition:opacity .5s;
        }
        #loadingOverlay.hidden{opacity:0;pointer-events:none}
        .loader{width:48px;height:48px;border:3px solid rgba(255,200,0,.15);border-top-color:#ffd000;border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loader-text{margin-top:16px;font-size:14px;color:rgba(255,255,255,.6)}

        .btn-settings{
            background:none;border:1px solid rgba(255,200,0,.3);color:rgba(255,255,255,.7);cursor:pointer;
            width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:all .2s;
        }
        .btn-settings:hover{background:rgba(255,200,0,.1);border-color:#ffd000;color:#ffd000}

        #settingsPanel{
            position:absolute;top:54px;right:20px;z-index:50;
            background:rgba(15,15,40,.95);backdrop-filter:blur(12px);
            border:1px solid rgba(255,200,0,.2);border-radius:10px;padding:16px;
            display:none;min-width:280px;
        }
        #settingsPanel.visible{display:block}
        #settingsPanel h3{font-size:13px;color:#ffd000;margin-bottom:12px;text-transform:uppercase;letter-spacing:1px}
        .setting-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0;color:rgba(255,255,255,.7);font-size:13px}
        .setting-row input[type="number"]{width:70px;padding:4px 8px;background:rgba(255,255,255,.08);border:1px solid rgba(255,200,0,.2);border-radius:6px;color:#fff;font-size:13px;text-align:right}
        .setting-note{font-size:11px;color:rgba(255,255,255,.35);padding:8px 0 0;border-top:1px solid rgba(255,255,255,.06);margin-top:8px}

        .cesium-viewer-toolbar,.cesium-viewer-animationContainer,
        .cesium-viewer-timelineContainer,.cesium-viewer-fullscreenContainer,
        .cesium-viewer-bottom{display:none!important}
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="loader"></div>
    <div class="loader-text" id="loaderText">Initializing Flight Tracker...</div>
</div>

<div id="topBar">
    <div class="logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/>
        </svg>
        SkyTracker
    </div>
    <div class="stats">
        Tracking <span id="flightCount">0</span> flights
        &nbsp;|&nbsp; Last update: <span id="lastUpdate">-</span>
        &nbsp;|&nbsp; Refresh: <span id="refreshInterval">15</span>s
    </div>
    <button class="btn-settings" id="btnSettings" title="Settings">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
    </button>
</div>

<div id="settingsPanel">
    <h3>Settings</h3>
    <div class="setting-row">
        <label>Refresh interval (sec)</label>
        <input type="number" id="inputRefresh" value="15" min="10" max="120" step="5">
    </div>
    <div class="setting-note">
        Anonymous mode: min 10s between requests<br>
        Default 15s for safety margin
    </div>
</div>

<div id="cesiumContainer"></div>

<div id="flightPopup">
    <div class="popup-header">
        <div class="callsign" id="popCallsign">-</div>
        <div class="country" id="popCountry">-</div>
    </div>
    <div class="popup-body">
        <div class="popup-grid">
            <div class="popup-item"><div class="label">ICAO24</div><div class="value" id="popIcao">-</div></div>
            <div class="popup-item"><div class="label">Altitude</div><div class="value"><span id="popAlt">-</span><span class="unit">ft</span></div></div>
            <div class="popup-item"><div class="label">Ground Speed</div><div class="value"><span id="popSpeed">-</span><span class="unit">kts</span></div></div>
            <div class="popup-item"><div class="label">Heading</div><div class="value"><span id="popHeading">-</span><span class="unit">deg</span></div></div>
            <div class="popup-item"><div class="label">Vert. Rate</div><div class="value"><span id="popVRate">-</span><span class="unit">ft/m</span></div></div>
            <div class="popup-item"><div class="label">Position</div><div class="value" id="popPos" style="font-size:11px">-</div></div>
            <div class="popup-item"><div class="label">Squawk</div><div class="value" id="popSquawk">-</div></div>
            <div class="popup-item"><div class="label">Source</div><div class="value" id="popSource">-</div></div>
        </div>
    </div>
</div>

<div id="statusBar">
    <div>
        <span class="api-badge"><span class="dot"></span> OpenSky Network</span>
        <span class="status-text" id="apiStatus">Connecting...</span>
    </div>
    <div>CesiumJS Globe | Browser-direct API (anonymous)</div>
</div>

<script>
// =====================================================================
//  CONFIGURATION
// =====================================================================
const CONFIG = {
    // REQUIRED: Your Cesium Ion access token
    // Get free at: https://ion.cesium.com/tokens
    CESIUM_ION_TOKEN: 'YOUR_CESIUM_ION_TOKEN_HERE',

    // Refresh interval in seconds (min 10 for anonymous OpenSky)
    // Using 15s default for safety margin against 429 rate limits
    REFRESH_INTERVAL: 15,

    // Initial camera view
    INITIAL_LAT: 39.33,
    INITIAL_LON: -91.85,
    INITIAL_ALT: 5000000,
};

// =====================================================================
//  GLOBALS
// =====================================================================
let viewer, refreshTimer, hoveredEntity;
let consecutiveErrors = 0;
const MAX_CONSECUTIVE_ERRORS = 3;
const flightEntities = new Map();

// =====================================================================
//  YELLOW AIRPLANE ICONS
// =====================================================================
function makeIcon(sz, col, glow) {
    const c = document.createElement('canvas');
    c.width = sz; c.height = sz;
    const g = c.getContext('2d'), cx = sz / 2, s = sz / 36;

    if (glow) {
        g.beginPath(); g.arc(cx, cx, sz / 2 - 2, 0, Math.PI * 2);
        g.strokeStyle = 'rgba(255,208,0,.35)'; g.lineWidth = 2; g.stroke();
    }
    g.save(); g.translate(cx, cx); g.fillStyle = col;

    g.beginPath();
    g.moveTo(0, -14 * s); g.lineTo(3 * s, -4 * s); g.lineTo(3 * s, 4 * s);
    g.lineTo(0, 14 * s); g.lineTo(-3 * s, 4 * s); g.lineTo(-3 * s, -4 * s);
    g.closePath(); g.fill();

    g.beginPath();
    g.moveTo(-14 * s, 1 * s); g.lineTo(-3 * s, -2 * s); g.lineTo(3 * s, -2 * s); g.lineTo(14 * s, 1 * s);
    g.lineTo(14 * s, 3 * s); g.lineTo(3 * s, 1 * s); g.lineTo(-3 * s, 1 * s); g.lineTo(-14 * s, 3 * s);
    g.closePath(); g.fill();

    g.beginPath();
    g.moveTo(-6 * s, 10 * s); g.lineTo(-2 * s, 7 * s); g.lineTo(2 * s, 7 * s); g.lineTo(6 * s, 10 * s);
    g.lineTo(6 * s, 11 * s); g.lineTo(2 * s, 9 * s); g.lineTo(-2 * s, 9 * s); g.lineTo(-6 * s, 11 * s);
    g.closePath(); g.fill();

    g.restore();
    return c.toDataURL();
}
const ICON = makeIcon(36, '#FFD000', false);
const ICON_HL = makeIcon(44, '#FFEA60', true);

// =====================================================================
//  INIT CESIUM
// =====================================================================
function initCesium() {
    Cesium.Ion.defaultAccessToken = CONFIG.CESIUM_ION_TOKEN;

    viewer = new Cesium.Viewer('cesiumContainer', {
        terrain: Cesium.Terrain.fromWorldTerrain(),
        baseLayerPicker: false, geocoder: false, homeButton: false,
        sceneModePicker: false, navigationHelpButton: false,
        animation: false, timeline: false, fullscreenButton: false,
        infoBox: false, selectionIndicator: false,
        creditContainer: document.createElement('div'),
    });

    viewer.scene.globe.enableLighting = true;
    viewer.scene.skyAtmosphere.brightnessShift = -0.2;
    viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(CONFIG.INITIAL_LON, CONFIG.INITIAL_LAT, CONFIG.INITIAL_ALT),
    });

    // Hover handler
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction(mv => {
        const pick = viewer.scene.pick(mv.endPosition);
        const popup = document.getElementById('flightPopup');

        if (Cesium.defined(pick) && pick.id && pick.id._fd) {
            const ent = pick.id, d = ent._fd;
            if (hoveredEntity && hoveredEntity !== ent) {
                hoveredEntity.billboard.image = ICON;
                hoveredEntity.billboard.scale = 0.8;
            }
            hoveredEntity = ent;
            ent.billboard.image = ICON_HL;
            ent.billboard.scale = 1.1;

            let px = mv.endPosition.x + 20, py = mv.endPosition.y - 20;
            const cw = viewer.canvas.clientWidth, ch = viewer.canvas.clientHeight;
            if (px + 350 > cw) px = mv.endPosition.x - 370;
            if (py + 320 > ch) py = ch - 330;
            if (py < 60) py = 60;
            popup.style.left = px + 'px';
            popup.style.top = py + 'px';
            fillPopup(d);
            popup.classList.add('visible');
        } else {
            if (hoveredEntity) {
                hoveredEntity.billboard.image = ICON;
                hoveredEntity.billboard.scale = 0.8;
                hoveredEntity = null;
            }
            popup.classList.remove('visible');
        }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
}

// =====================================================================
//  FILL POPUP
// =====================================================================
function fillPopup(d) {
    const cs = (d.callsign || '').trim();
    document.getElementById('popCallsign').textContent = cs || d.icao24.toUpperCase();
    document.getElementById('popCountry').textContent = d.origin_country || '-';
    document.getElementById('popIcao').textContent = d.icao24.toUpperCase();
    document.getElementById('popAlt').textContent = d.baro_altitude != null ? Math.round(d.baro_altitude * 3.28084).toLocaleString() : '-';
    document.getElementById('popSpeed').textContent = d.velocity != null ? Math.round(d.velocity * 1.94384) : '-';
    document.getElementById('popHeading').textContent = d.true_track != null ? Math.round(d.true_track) : '-';
    document.getElementById('popVRate').textContent = d.vertical_rate != null ? Math.round(d.vertical_rate * 196.85) : '-';
    document.getElementById('popPos').textContent = d.latitude != null ? d.latitude.toFixed(3) + ', ' + d.longitude.toFixed(3) : '-';
    document.getElementById('popSquawk').textContent = d.squawk || '-';
    document.getElementById('popSource').textContent = ['ADS-B', 'ASTERIX', 'MLAT', 'FLARM'][d.position_source] || '-';
}

// =====================================================================
//  STATUS UI
// =====================================================================
function setStatus(text, cls) {
    const el = document.getElementById('apiStatus');
    el.textContent = text;
    el.className = 'status-text ' + (cls || '');
}

// =====================================================================
//  FETCH FLIGHTS - Direct browser call to OpenSky (anonymous)
//  OpenSky allows browser CORS for /api/states/all (just not /auth/)
// =====================================================================
async function fetchFlights() {
    try {
        const params = [];
        const rect = viewer.camera.computeViewRectangle();
        if (rect) {
            const w = Cesium.Math.toDegrees(rect.west),
                  s = Cesium.Math.toDegrees(rect.south),
                  e = Cesium.Math.toDegrees(rect.east),
                  n = Cesium.Math.toDegrees(rect.north);
            if (Math.max(e - w, n - s) < 150) {
                params.push('lamin=' + s.toFixed(2), 'lomin=' + w.toFixed(2),
                             'lamax=' + n.toFixed(2), 'lomax=' + e.toFixed(2));
            }
        }
        const qs = params.length ? '?' + params.join('&') : '';
        const url = 'https://opensky-network.org/api/states/all' + qs;

        const res = await fetch(url);

        if (res.status === 429) {
            consecutiveErrors++;
            const backoff = Math.min(consecutiveErrors * 5, 60);
            setStatus('Rate limited - waiting ' + backoff + 's...', 'status-warn');
            console.warn('[API] 429 Too Many Requests. Backing off ' + backoff + 's');
            // Temporarily increase refresh interval
            if (refreshTimer) clearInterval(refreshTimer);
            setTimeout(() => {
                refreshTimer = setInterval(fetchFlights, CONFIG.REFRESH_INTERVAL * 1000);
                fetchFlights();
            }, backoff * 1000);
            return;
        }

        if (!res.ok) {
            consecutiveErrors++;
            setStatus('Error: ' + res.status, 'status-err');
            console.warn('[API] Error:', res.status);
            return;
        }

        const json = await res.json();
        if (!json || !json.states) {
            setStatus('No flight data received', 'status-warn');
            return;
        }

        // Success
        consecutiveErrors = 0;
        processStates(json.states);
        document.getElementById('flightCount').textContent = json.states.length.toLocaleString();
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        setStatus('Live - anonymous (' + CONFIG.REFRESH_INTERVAL + 's refresh)', 'status-ok');

    } catch (err) {
        consecutiveErrors++;
        console.error('[API] Fetch error:', err);
        setStatus('Connection error', 'status-err');
    }
}

// =====================================================================
//  PROCESS STATE VECTORS
// =====================================================================
function processStates(states) {
    const seen = new Set();
    for (const s of states) {
        const icao = s[0], lon = s[5], lat = s[6];
        if (lat == null || lon == null) continue;
        seen.add(icao);

        const d = {
            icao24: icao, callsign: s[1], origin_country: s[2],
            longitude: lon, latitude: lat,
            baro_altitude: s[7], on_ground: s[8],
            velocity: s[9], true_track: s[10], vertical_rate: s[11],
            geo_altitude: s[13], squawk: s[14], position_source: s[16],
        };

        const alt = d.baro_altitude || d.geo_altitude || 0;
        const hdg = d.true_track || 0;

        if (flightEntities.has(icao)) {
            const ent = flightEntities.get(icao);
            ent.position = Cesium.Cartesian3.fromDegrees(lon, lat, alt);
            ent.billboard.rotation = Cesium.Math.toRadians(-hdg);
            ent._fd = d;
        } else {
            const ent = viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(lon, lat, alt),
                billboard: {
                    image: ICON, scale: 0.8,
                    rotation: Cesium.Math.toRadians(-hdg),
                    verticalOrigin: Cesium.VerticalOrigin.CENTER,
                    horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
                    heightReference: Cesium.HeightReference.NONE,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY,
                    translucencyByDistance: new Cesium.NearFarScalar(1e3, 1, 1e7, 0.6),
                    scaleByDistance: new Cesium.NearFarScalar(1e4, 1.2, 1e7, 0.3),
                },
            });
            ent._fd = d;
            flightEntities.set(icao, ent);
        }
    }
    for (const [icao, ent] of flightEntities) {
        if (!seen.has(icao)) {
            viewer.entities.remove(ent);
            flightEntities.delete(icao);
        }
    }
}

// =====================================================================
//  SETTINGS
// =====================================================================
document.getElementById('btnSettings').addEventListener('click', () =>
    document.getElementById('settingsPanel').classList.toggle('visible'));

document.getElementById('inputRefresh').addEventListener('change', e => {
    let v = Math.max(10, Math.min(120, parseInt(e.target.value)));
    e.target.value = v;
    CONFIG.REFRESH_INTERVAL = v;
    document.getElementById('refreshInterval').textContent = v;
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(fetchFlights, v * 1000);
});

document.addEventListener('click', e => {
    const p = document.getElementById('settingsPanel');
    const b = document.getElementById('btnSettings');
    if (!p.contains(e.target) && e.target !== b && !b.contains(e.target))
        p.classList.remove('visible');
});

// =====================================================================
//  BOOT
// =====================================================================
(async function boot() {
    const loaderText = document.getElementById('loaderText');

    try {
        loaderText.textContent = 'Loading 3D globe...';
        initCesium();

        loaderText.textContent = 'Fetching live flights...';
        document.getElementById('refreshInterval').textContent = CONFIG.REFRESH_INTERVAL;
        document.getElementById('inputRefresh').value = CONFIG.REFRESH_INTERVAL;

        await fetchFlights();

        refreshTimer = setInterval(fetchFlights, CONFIG.REFRESH_INTERVAL * 1000);

        document.getElementById('loadingOverlay').classList.add('hidden');
    } catch (err) {
        console.error('[Boot] Error:', err);
        loaderText.textContent = 'Error: Check console. Is Cesium Ion token set?';
    }
})();
</script>
</body>
</html>
